<!-- /index.html  (Inky Vibes Tattoo - Reservation System)
  - Logo local file: 01.jpg (same folder as index.html)
  - Clicking logo/title navigates to Upcoming Bookings
  - Hamburger menu
  - Upcoming Bookings (future only, nearest first)
  - Bookings -> Design/Tattoo (past+future, newest first)
  - Customers + Edit modal
  - New/Edit booking form
  - Searchable customer input (type to find)
  - Add new customer inside booking form (creates on save)
  - Images in IndexedDB + thumbnails
  - Edit booking: existing images list + remove single + remove all + add more
  - Delete confirmation modal
  - Phone input: +358 prefix enforced, no double prefix
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inky Vibes Tattoo - Reservation System</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5a677a;
      --border:rgba(16, 24, 40, .12);
      --accent:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#f59e0b;
      --shadow:0 10px 26px rgba(16,24,40,.08);
      --r:14px;
      --gap:14px;

      --type-tattoo:#f59e0b;
      --type-design:#2563eb;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{ color:inherit; text-decoration:none; }
    button,input,select,textarea{ font:inherit; }

    header{
      position:sticky; top:0; z-index:60;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }
    .hLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .hambtn{
      width:42px; height:40px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:inline-grid; place-items:center;
      user-select:none;
    }
    .hambtn:hover{ background:rgba(16,24,40,.03); }

    .brandline{
      display:flex; align-items:center; gap:10px; min-width:0;
      cursor:pointer;
      user-select:none;
    }
    .brandlogo{
      width:40px; height:40px; border-radius:999px;
      border:1px solid var(--border);
      background:#fff; object-fit:cover;
      box-shadow: 0 6px 16px rgba(16,24,40,.08);
      flex:0 0 auto;
    }
    .brandtext{ display:flex; flex-direction:column; min-width:0; }
    .brandtitle{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandsub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .container{ padding:16px; max-width:1120px; margin:0 auto; }
    .grid{ display:grid; gap:var(--gap); }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{ font-size:18px; font-weight:900; margin:0; }
    .subtitle{ margin:6px 0 0; font-size:13px; color:var(--muted); line-height:1.35; }
    .card-b{ padding:16px; }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform,.15s background;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ background:rgba(16,24,40,.03); transform:translateY(-1px); }
    .btn.primary{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.28);
      color:rgba(37,99,235,.95);
    }
    .btn.danger{
      background:rgba(220,38,38,.08);
      border-color:rgba(220,38,38,.25);
      color:rgba(220,38,38,.95);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .search{
      display:flex; align-items:center; gap:10px;
      flex:1; min-width:240px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .search input{ width:100%; border:none; outline:none; background:transparent; color:var(--text); }

    .table-wrap{
      overflow:auto;
      border-radius:var(--r);
      border:1px solid var(--border);
      background:#fff;
    }
    table{ width:100%; border-collapse:collapse; min-width:1020px; }
    th,td{
      padding:12px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:14px;
      vertical-align:top;
    }
    th{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .iconbtn{
      width:40px; height:36px;
      display:inline-grid; place-items:center;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .iconbtn:hover{ background:rgba(16,24,40,.03); }

    .pill{
      display:inline-flex; align-items:center;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-weight:700;
    }
    .pill.ok{ border-color:rgba(22,163,74,.25); color:rgba(22,163,74,.95); background:rgba(22,163,74,.06); }
    .pill.warn{ border-color:rgba(245,158,11,.28); color:rgba(245,158,11,.95); background:rgba(245,158,11,.08); }
    .pill.danger{ border-color:rgba(220,38,38,.25); color:rgba(220,38,38,.95); background:rgba(220,38,38,.06); }

    .type-pill{
      display:inline-flex; align-items:center;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
    }
    .type-pill.tattoo{ border-color:rgba(245,158,11,.35); color:var(--type-tattoo); background:rgba(245,158,11,.10); }
    .type-pill.design{ border-color:rgba(37,99,235,.30); color:var(--type-design); background:rgba(37,99,235,.10); }

    .thumbs{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .thumb{
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#fff;
      cursor:pointer;
    }
    .thumbMore{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(16,24,40,.02);
    }

    /* Existing images editor (inside booking form) */
    .imgEditGrid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .imgEditItem{
      width:92px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:8px;
      box-shadow: 0 6px 18px rgba(16,24,40,.06);
    }
    .imgEditItem img{
      width:100%;
      height:68px;
      border-radius:10px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#fff;
      cursor:pointer;
    }
    .imgEditActions{
      display:flex; gap:8px; justify-content:center;
      margin-top:8px;
    }
    .miniBtn{
      width:34px; height:30px;
      display:inline-grid; place-items:center;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .miniBtn:hover{ background:rgba(16,24,40,.03); }
    .miniBtn.danger{
      border-color:rgba(220,38,38,.25);
      background:rgba(220,38,38,.06);
      color:rgba(220,38,38,.95);
    }

    .phoneHint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    form .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:7px; margin-bottom:12px; }
    label{ font-size:12px; color:var(--muted); letter-spacing:.02em; }
    .req::after{ content:" *"; color:var(--danger); font-weight:800; }
    input,select,textarea{
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{ resize:vertical; min-height:92px; }
    .help{ font-size:12px; color:var(--muted); line-height:1.35; }
    .form-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding-top:6px; }

    .toggleBox{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(16,24,40,.02);
      padding:12px;
      margin:10px 0 12px;
    }

    .toast{
      position:fixed;
      right:16px; bottom:16px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow:var(--shadow);
      display:none;
      max-width:min(520px, calc(100% - 32px));
      z-index:3000;
      font-size:14px;
    }

    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(11,18,32,.28);
      display:none;
      z-index:2000;
      padding:16px;
    }
    .modal{
      max-width:640px;
      margin:6vh auto 0;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalH{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .modalT{ font-weight:900; margin:0; font-size:16px; }
    .modalB{ padding:16px; }
    .closeX{
      width:38px;height:36px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .closeX:hover{ background:rgba(16,24,40,.03); }

    .gallery{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .gallery img{
      width:100%;
      height:120px;
      border-radius:12px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#fff;
      cursor:pointer;
    }
    .viewer{
      display:none;
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .viewer img{ width:100%; height:auto; display:block; }

    .inlineRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:6px;
    }

    /* Drawer */
    .drawerOverlay{
      position:fixed; inset:0;
      background:rgba(11,18,32,.28);
      display:none;
      z-index:1000;
    }
    .drawer{
      position:fixed; top:0; left:0; bottom:0;
      width:min(340px, 86vw);
      background:#fff;
      border-right:1px solid var(--border);
      box-shadow: var(--shadow);
      transform:translateX(-110%);
      transition: transform .18s ease;
      z-index:1100;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform:translateX(0); }
    .drawerHeader{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .drawerBrand{
      display:flex; align-items:center; gap:10px; min-width:0;
      cursor:pointer;
      user-select:none;
    }
    .drawerBrand img{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#fff;
      flex:0 0 auto;
    }
    .drawerBrand .t1{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .drawerBrand .t2{ font-size:12px; color:var(--muted); margin-top:2px; }
    .drawerNav{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .navItem{
      display:flex; align-items:center; gap:10px;
      padding:12px;
      border:1px solid var(--border);
      background:rgba(16,24,40,.02);
      border-radius:12px;
      cursor:pointer;
      user-select:none;
    }
    .navItem.active{
      border-color:rgba(37,99,235,.35);
      background:rgba(37,99,235,.08);
    }
    .navIcon{
      width:26px; height:26px; display:inline-grid; place-items:center;
      border-radius:9px;
      background:rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.25);
      font-size:12px;
      color:rgba(37,99,235,.95);
      font-weight:800;
      flex:0 0 auto;
    }

    /* Responsive */
    @media (max-width: 640px){
      form .row{ grid-template-columns:1fr; }
      .container{ padding:14px; }
      .gallery{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      table{ min-width: 860px; }
      .iconbtn{ width:44px; height:40px; }
      .btn{ padding:11px 13px; }
      .search{ min-width: 0; }
    }
  </style>
</head>

<body>
  <!-- Drawer -->
  <div class="drawerOverlay" id="drawerOverlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerBrand" id="drawerBrandLink" title="Go to Upcoming Bookings">
        <img id="drawerLogo" alt="Logo" />
        <div style="min-width:0;">
          <div class="t1">Inky Vibes Tattoo</div>
          <div class="t2">Reservation System</div>
        </div>
      </div>
      <button class="closeX" type="button" id="drawerClose">‚úï</button>
    </div>

    <div class="drawerNav" id="drawerNav">
      <div class="navItem" data-route="/upcoming">
        <span class="navIcon">U</span> Upcoming Bookings
      </div>

      <div class="navItem" data-route="/bookings">
        <span class="navIcon">B</span> Bookings
      </div>

      <div class="navItem" data-route="/customers">
        <span class="navIcon">C</span> Customers
      </div>

      <div class="navItem" data-route="/booking/new">
        <span class="navIcon">+</span> + New Booking
      </div>
    </div>
  </aside>

  <header>
    <div class="hLeft">
      <button class="hambtn" id="hambtn" aria-label="Open menu">‚ò∞</button>

      <!-- Clickable brand -> Upcoming -->
      <div class="brandline" id="topBrandLink" title="Go to Upcoming Bookings">
        <img id="topLogo" class="brandlogo" alt="Logo" />
        <div class="brandtext">
          <div class="brandtitle">Inky Vibes Tattoo - Reservation System</div>
          <div class="brandsub" id="headerSubtitle">Bookings & customers management</div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- UPCOMING BOOKINGS -->
    <section id="view-upcoming" class="grid" style="display:none;">
      <div class="card">
        <div class="card-h">
          <div>
            <h2 class="title">Upcoming Bookings</h2>
            <p class="subtitle">Sorted by date (nearest first).</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <a class="btn primary" href="#/booking/new">+ New Booking</a>
          </div>
        </div>
        <div class="card-b">
          <div class="toolbar">
            <div class="search">
              <span style="color:var(--muted);font-size:12px;">üîé</span>
              <input id="upSearch" placeholder="Search upcoming bookings‚Ä¶" />
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <select id="upTypeFilter">
                <option value="" selected>Type</option>
                <option>Design</option>
                <option>Tattoo</option>
              </select>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:140px;">Type</th>
                  <th style="min-width:220px;">Customer</th>
                  <th style="min-width:140px;">Phone</th>
                  <th style="min-width:220px;">Images</th>
                  <th style="min-width:150px;">Status</th>
                  <th style="min-width:200px;">Date</th>
                  <th style="min-width:220px;">Actions</th>
                </tr>
              </thead>
              <tbody id="upTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- BOOKINGS HUB -->
    <section id="view-bookings-hub" class="grid" style="display:none;">
      <div class="card">
        <div class="card-h">
          <div>
            <h2 class="title">Bookings</h2>
            <p class="subtitle">Choose Design or Tattoo bookings.</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <a class="btn primary" href="#/booking/new">+ New Booking</a>
          </div>
        </div>
        <div class="card-b" style="display:flex;gap:12px;flex-wrap:wrap;">
          <a class="btn primary" href="#/bookings/design">Design bookings</a>
          <a class="btn primary" href="#/bookings/tattoo">Tattoo bookings</a>
        </div>
      </div>
    </section>

    <!-- BOOKINGS LIST -->
    <section id="view-bookings-list" class="grid" style="display:none;">
      <div class="card">
        <div class="card-h">
          <div>
            <h2 class="title" id="allTitle">Bookings</h2>
            <p class="subtitle">All bookings (past + future), newest first.</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <a class="btn" href="#/bookings">‚Üê Back</a>
            <a class="btn primary" href="#/booking/new">+ New Booking</a>
          </div>
        </div>
        <div class="card-b">
          <div class="toolbar">
            <div class="search">
              <span style="color:var(--muted);font-size:12px;">üîé</span>
              <input id="allSearch" placeholder="Search bookings‚Ä¶" />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:140px;">Type</th>
                  <th style="min-width:220px;">Customer</th>
                  <th style="min-width:140px;">Phone</th>
                  <th style="min-width:220px;">Images</th>
                  <th style="min-width:150px;">Status</th>
                  <th style="min-width:200px;">Date</th>
                  <th style="min-width:220px;">Actions</th>
                </tr>
              </thead>
              <tbody id="allTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- BOOKING FORM -->
    <section id="view-booking-form" class="grid" style="display:none;">
      <div class="card">
        <div class="card-h">
          <div>
            <h2 class="title" id="bookingFormTitle">+ New Booking</h2>
            <p class="subtitle">Create a new booking or edit an existing one.</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <a class="btn" href="#/upcoming">‚Üê Back</a>
          </div>
        </div>

        <div class="card-b">
          <form id="bookingForm" novalidate>
            <input type="hidden" id="bookingId" />
            <input type="hidden" id="customerId" />

            <div class="row">
              <div class="field">
                <label class="req" for="customerSearch">Select customer</label>
                <input
                  id="customerSearch"
                  list="customerDatalist"
                  placeholder="Type name / phone / email (e.g. jo, 040, @hotmail)"
                  autocomplete="off"
                  required
                />
                <datalist id="customerDatalist"></datalist>

                <div class="inlineRow">
                  <div class="help">Type and pick from list. Customer will auto-fill.</div>
                  <button class="btn primary" type="button" id="addCustomerBtn">+ Add New Customer</button>
                </div>
              </div>

              <div class="field">
                <label class="req" for="paymentMethod">Payment method</label>
                <select id="paymentMethod" required>
                  <option>Cash</option>
                  <option>Credit Card</option>
                  <option>Klarna</option>
                  <option>Mobile Payments</option>
                </select>
              </div>
            </div>

            <div class="toggleBox" id="addCustomerBox" style="display:none;">
              <div style="font-weight:900;margin-bottom:8px;">+ Add New Customer</div>
              <div class="row">
                <div class="field">
                  <label class="req" for="newCustName">Customer name</label>
                  <input id="newCustName" placeholder="e.g. John Smith" />
                </div>
                <div class="field">
                  <label for="newCustEmail">Email</label>
                  <input id="newCustEmail" type="email" placeholder="email@example.com" />
                </div>
              </div>
              <div class="row">
                <div class="field">
                  <label for="newCustPhone">Phone</label>
                  <input id="newCustPhone" inputmode="tel" placeholder="+358 40..." />
                  <div class="phoneHint">+358 stays (no double prefix).</div>
                </div>
                <div class="field">
                  <label for="newCustNotes">Notes</label>
                  <input id="newCustNotes" placeholder="Optional" />
                </div>
              </div>
              <div class="help">Customer will be created when you save the booking.</div>
            </div>

            <div class="row">
              <div class="field">
                <label class="req" for="bookingType">Booking type</label>
                <select id="bookingType" required>
                  <option>Design</option>
                  <option>Tattoo</option>
                </select>
              </div>
              <div class="field">
                <label class="req" for="bookingDate">Booking date</label>
                <input id="bookingDate" type="datetime-local" required />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label class="req" for="status">Status</label>
                <select id="status" required>
                  <option>Approved</option>
                  <option>Pending</option>
                  <option>Cancelled</option>
                  <option>Done</option>
                </select>
              </div>
              <div class="field">
                <label for="currency">Currency</label>
                <select id="currency">
                  <option value="EUR">EUR</option>
                  <option value="USD">USD</option>
                  <option value="GBP">GBP</option>
                  <option value="SEK">SEK</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="total">Total</label>
                <input id="total" inputmode="decimal" placeholder="0.00" />
              </div>
              <div class="field">
                <label for="advance">Advance</label>
                <input id="advance" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="remaining">Remaining</label>
                <input id="remaining" readonly />
                <div class="help">Auto: total - advance</div>
              </div>
              <div class="field">
                <label for="images">Add images</label>
                <input id="images" type="file" multiple accept="image/*" />
                <div class="help">You can add more images anytime.</div>
              </div>
            </div>

            <div class="field" id="existingImagesBox" style="display:none;">
              <label>Existing images</label>
              <div class="inlineRow" style="margin-top:2px;">
                <div class="help">Tap üóëÔ∏è to remove an image (removed when you Save).</div>
                <button class="btn danger" type="button" id="removeAllImagesBtn">Remove all</button>
              </div>
              <div class="imgEditGrid" id="existingImagesGrid"></div>
            </div>

            <div class="field">
              <label for="note">Note</label>
              <textarea id="note" placeholder="Client note..."></textarea>
            </div>

            <div class="form-actions">
              <button class="btn danger" type="button" id="deleteBookingBtn" style="display:none;">Delete</button>
              <button class="btn" type="button" id="cancelBookingBtn">Cancel</button>
              <button class="btn primary" type="submit" id="saveBookingBtn">Save booking</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section id="view-customers" class="grid" style="display:none;">
      <div class="card">
        <div class="card-h">
          <div>
            <h2 class="title">Customers</h2>
            <p class="subtitle">Tap Edit to update customer details.</p>
          </div>
        </div>
        <div class="card-b">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:240px;">Name</th>
                  <th style="min-width:240px;">Email</th>
                  <th style="min-width:180px;">Phone</th>
                  <th style="min-width:220px;">Actions</th>
                </tr>
              </thead>
              <tbody id="customersTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Customer Edit Modal -->
  <div class="modalOverlay" id="custModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="custModalTitle">
      <div class="modalH">
        <p class="modalT" id="custModalTitle">Edit Customer</p>
        <button class="closeX" type="button" id="custModalClose">‚úï</button>
      </div>
      <div class="modalB">
        <form id="custEditForm" novalidate>
          <input type="hidden" id="custEditId" />
          <div class="field">
            <label class="req" for="custEditName">Name</label>
            <input id="custEditName" required />
          </div>
          <div class="field">
            <label for="custEditEmail">Email</label>
            <input id="custEditEmail" type="email" />
          </div>
          <div class="field">
            <label for="custEditPhone">Phone</label>
            <input id="custEditPhone" inputmode="tel" placeholder="+358 40..." />
            <div class="phoneHint">+358 stays (no double prefix).</div>
          </div>
          <div class="field">
            <label for="custEditNotes">Notes</label>
            <input id="custEditNotes" />
          </div>
          <div class="form-actions">
            <button class="btn" type="button" id="custEditCancel">Cancel</button>
            <button class="btn primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Images Preview Modal -->
  <div class="modalOverlay" id="imgModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="imgModalTitle">
      <div class="modalH">
        <p class="modalT" id="imgModalTitle">Booking Images</p>
        <button class="closeX" type="button" id="imgModalClose">‚úï</button>
      </div>
      <div class="modalB">
        <div class="gallery" id="imgGallery"></div>
        <div class="viewer" id="imgViewer">
          <img id="imgViewerImg" alt="Preview" />
        </div>
        <div class="help" style="margin-top:10px;">Tap an image to preview.</div>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modalOverlay" id="confirmOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modalH">
        <p class="modalT" id="confirmTitle">Confirm delete</p>
        <button class="closeX" type="button" id="confirmClose">‚úï</button>
      </div>
      <div class="modalB">
        <div id="confirmText" style="color:var(--muted);line-height:1.4;">Are you sure?</div>
        <div class="form-actions" style="margin-top:14px;">
          <button class="btn" type="button" id="confirmCancel">Cancel</button>
          <button class="btn danger" type="button" id="confirmYes">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Local logo file (same folder as index.html)
    const LOGO_URL = "./01.jpg";

    // localStorage keys (metadata only)
    const LS = { customers: "inky_customers_v10", bookings: "inky_bookings_v10" };

    // IndexedDB for image blobs
    const IDB_NAME = "inky_vibes_db_v1";
    const IDB_VERSION = 1;
    const STORE_IMAGES = "images";

    const $ = (s) => document.querySelector(s);

    let currentRemovedImageIds = new Set(); // in edit booking

    function uid(prefix=""){ return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function parseJson(v, fb){ try { return JSON.parse(v) ?? fb; } catch { return fb; } }
    function loadCustomers(){ return parseJson(localStorage.getItem(LS.customers), []); }
    function loadBookings(){ return parseJson(localStorage.getItem(LS.bookings), []); }

    function safeSetLocalStorage(key, value){
      try { localStorage.setItem(key, value); return { ok:true }; }
      catch (e) { return { ok:false, error:e }; }
    }
    function saveCustomers(v){
      const res = safeSetLocalStorage(LS.customers, JSON.stringify(v));
      if (!res.ok) throw res.error;
    }
    function saveBookings(v){
      const res = safeSetLocalStorage(LS.bookings, JSON.stringify(v));
      if (!res.ok) throw res.error;
    }

    function toast(msg){
      const el = $("#toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(window.__toast);
      window.__toast = setTimeout(() => (el.style.display="none"), 2600);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    function money(v){
      const s = String(v ?? "").replace(",", ".").trim();
      const n = Number.parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }
    function toLocalDT(d){
      const p = (x)=>String(x).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    function fmtDT(iso){
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      const p = (x)=>String(x).padStart(2,"0");
      return `${p(d.getDate())}.${p(d.getMonth()+1)}.${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    function pillClass(status){
      const s = (status||"").toLowerCase();
      if (s === "approved" || s === "done") return "ok";
      if (s === "pending") return "warn";
      if (s === "cancelled") return "danger";
      return "";
    }
    function typePill(type){
      const t = (type || "").toLowerCase();
      if (t === "tattoo") return `<span class="type-pill tattoo">Tattoo</span>`;
      if (t === "design") return `<span class="type-pill design">Design</span>`;
      return escapeHtml(type || "‚Äî");
    }
    function isUpcoming(iso){
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return true;
      return d.getTime() >= Date.now();
    }

    // PHONE: enforce +358, avoid double prefix
    function normalizeFiPhone(raw){
      const s0 = String(raw ?? "").trim();
      if (!s0) return "";
      const cleaned = s0.replace(/\s+/g, "");
      if (cleaned.startsWith("+358")) return "+358" + cleaned.slice(4).replace(/[^\d]/g, "");
      if (cleaned.startsWith("358")) return "+358" + cleaned.slice(3).replace(/[^\d]/g, "");
      if (cleaned.startsWith("0")) return "+358" + cleaned.slice(1).replace(/[^\d]/g, "");
      const digits = cleaned.replace(/[^\d]/g, "");
      return digits ? "+358" + digits : "";
    }

    function enforcePlus358(inputEl){
      const ensurePrefix = () => {
        const v = String(inputEl.value ?? "");
        if (!v) return;
        const norm = normalizeFiPhone(v);
        if (norm && norm !== v) inputEl.value = norm;
      };

      inputEl.addEventListener("focus", () => {
        if (!inputEl.value.trim()) inputEl.value = "+358";
        ensurePrefix();
      });

      inputEl.addEventListener("blur", () => {
        const v = inputEl.value.trim();
        if (!v) return;
        inputEl.value = normalizeFiPhone(v) || "";
      });

      inputEl.addEventListener("input", () => {
        const v = inputEl.value;
        if (v && v.startsWith("+358+358")) inputEl.value = "+358" + v.slice(8);
        if (v && v.startsWith("+358358")) inputEl.value = "+358" + v.slice(7);
      });

      inputEl.addEventListener("keydown", (e) => {
        if (e.key !== "Backspace" && e.key !== "Delete") return;
        const v = inputEl.value || "";
        if (!v.startsWith("+358")) return;
        const pos = inputEl.selectionStart ?? 0;
        if (pos <= 4) e.preventDefault(); // keep "+358"
      });
    }

    // Drawer
    function openDrawer(){
      $("#drawerOverlay").style.display = "block";
      $("#drawerOverlay").setAttribute("aria-hidden","false");
      $("#drawer").classList.add("open");
      $("#drawer").setAttribute("aria-hidden","false");
    }
    function closeDrawer(){
      $("#drawerOverlay").style.display = "none";
      $("#drawerOverlay").setAttribute("aria-hidden","true");
      $("#drawer").classList.remove("open");
      $("#drawer").setAttribute("aria-hidden","true");
    }
    function go(route){
      closeDrawer();
      location.hash = "#" + route;
    }
    function setActiveDrawer(route){
      document.querySelectorAll("#drawerNav .navItem").forEach(el=>{
        el.classList.toggle("active", el.dataset.route === route);
      });
    }

    // Brand click -> upcoming
    function goUpcoming(){
      closeDrawer();
      location.hash = "#/upcoming";
    }

    // Confirm modal
    function openConfirm({ title = "Confirm delete", text = "Are you sure?", onYes }) {
      $("#confirmTitle").textContent = title;
      $("#confirmText").textContent = text;

      const overlay = $("#confirmOverlay");
      overlay.style.display = "block";
      overlay.setAttribute("aria-hidden", "false");

      const cleanup = () => {
        overlay.style.display = "none";
        overlay.setAttribute("aria-hidden", "true");
        $("#confirmYes").onclick = null;
      };

      $("#confirmYes").onclick = async () => {
        try { await onYes?.(); }
        finally { cleanup(); }
      };

      $("#confirmClose").onclick = cleanup;
      $("#confirmCancel").onclick = cleanup;
      overlay.onclick = (e) => { if (e.target === overlay) cleanup(); };
    }

    // IndexedDB
    function openDb(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(IDB_NAME, IDB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE_IMAGES)){
            db.createObjectStore(STORE_IMAGES, { keyPath: "id" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbPutImage({ blob, name, mime }){
      const db = await openDb();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE_IMAGES, "readwrite");
        const store = tx.objectStore(STORE_IMAGES);
        const id = uid("img_");
        store.put({ id, blob, name, mime, createdAt: new Date().toISOString() });
        tx.oncomplete = () => resolve(id);
        tx.onerror = () => reject(tx.error);
      });
    }
    async function idbGetImage(id){
      const db = await openDb();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE_IMAGES, "readonly");
        const store = tx.objectStore(STORE_IMAGES);
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbDeleteImage(id){
      const db = await openDb();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE_IMAGES, "readwrite");
        const store = tx.objectStore(STORE_IMAGES);
        store.delete(id);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    // Customers index
    function formatCustomerLabel(c){
      const parts = [c.name];
      if (c.phone) parts.push(c.phone);
      if (c.email) parts.push(c.email);
      return parts.join(" ‚Äî ");
    }
    function buildCustomerIndex(){
      const customers = loadCustomers().slice().sort((a,b)=>a.name.localeCompare(b.name));
      const mapLabelToId = new Map();
      const dl = $("#customerDatalist");
      dl.innerHTML = "";
      for (const c of customers) {
        const label = formatCustomerLabel(c);
        const opt = document.createElement("option");
        opt.value = label;
        dl.appendChild(opt);
        mapLabelToId.set(label, c.id);
      }
      window.__customerLabelToId = mapLabelToId;
    }
    function setSelectedCustomerById(id){
      const c = loadCustomers().find(x => x.id === id);
      if (!c) return;
      $("#customerId").value = c.id;
      $("#customerSearch").value = formatCustomerLabel(c);
    }
    function clearSelectedCustomer(){ $("#customerId").value = ""; }
    function showAddCustomerBox(show){
      $("#addCustomerBox").style.display = show ? "block" : "none";
      if (show) $("#newCustName").focus();
    }
    function clearNewCustomerFields(){
      $("#newCustName").value = "";
      $("#newCustEmail").value = "";
      $("#newCustPhone").value = "";
      $("#newCustNotes").value = "";
    }

    function validateAndGetCustomerId(){
      const label = $("#customerSearch").value.trim();
      const map = window.__customerLabelToId || new Map();
      const existingId = map.get(label);

      const addBoxVisible = $("#addCustomerBox").style.display !== "none";
      if (!addBoxVisible){
        if (existingId) { $("#customerId").value = existingId; return existingId; }
        const hiddenId = $("#customerId").value;
        if (hiddenId) return hiddenId;
        toast("Type customer and select from list, or click + Add New Customer.");
        return null;
      }

      const name = $("#newCustName").value.trim();
      const email = $("#newCustEmail").value.trim();
      const phone = normalizeFiPhone($("#newCustPhone").value.trim());
      const notes = $("#newCustNotes").value.trim();
      if (!name) { toast("New customer name is required."); return null; }

      const customers = loadCustomers();
      const newCustomer = { id: uid("c_"), name, email, phone, notes, createdAt: new Date().toISOString() };
      try{
        customers.push(newCustomer);
        saveCustomers(customers);
      }catch(e){
        toast("Storage error: cannot save customer.");
        return null;
      }

      buildCustomerIndex();
      showAddCustomerBox(false);
      clearNewCustomerFields();
      setSelectedCustomerById(newCustomer.id);
      return newCustomer.id;
    }

    // Images
    async function fileToImageEl(file){
      const url = URL.createObjectURL(file);
      try{
        const img = await new Promise((resolve, reject)=>{
          const i = new Image();
          i.onload = () => resolve(i);
          i.onerror = () => reject(new Error("Image load failed"));
          i.src = url;
        });
        return img;
      } finally {
        URL.revokeObjectURL(url);
      }
    }
    async function makeThumbnailDataUrl(file, maxSide=320, quality=0.78){
      const img = await fileToImageEl(file);
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxSide / Math.max(w,h));
      const cw = Math.max(1, Math.round(w * scale));
      const ch = Math.max(1, Math.round(h * scale));
      const canvas = document.createElement("canvas");
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, cw, ch);
      return canvas.toDataURL("image/jpeg", quality);
    }
    async function readAndStoreImages(fileInput){
      const files = Array.from(fileInput.files || []);
      const images = files.filter(f => (f.type || "").startsWith("image/"));
      if (!images.length) return [];
      const out = [];
      for (const f of images){
        const thumb = await makeThumbnailDataUrl(f);
        const id = await idbPutImage({ blob: f, name: f.name, mime: f.type || "image/*" });
        out.push({ id, name: f.name, thumb });
      }
      return out;
    }
    function renderThumbs(images, bookingId){
      const list = Array.isArray(images) ? images : [];
      if (!list.length) return `<span style="color:var(--muted)">‚Äî</span>`;
      const shown = list.slice(0, 3);
      const more = list.length - shown.length;
      const thumbTags = shown.map((img) => {
        const safe = escapeAttr(img.thumb || "");
        return `<img class="thumb" src="${safe}" alt="img" data-open-gallery="${escapeAttr(bookingId)}" />`;
      }).join("");
      const moreHtml = more > 0 ? `<span class="thumbMore">+${more}</span>` : "";
      return `<div class="thumbs">${thumbTags}${moreHtml}</div>`;
    }
    function openImgModal(images){
      const overlay = $("#imgModalOverlay");
      const gallery = $("#imgGallery");
      const viewer = $("#imgViewer");
      const viewerImg = $("#imgViewerImg");

      gallery.innerHTML = "";
      viewer.style.display = "none";
      viewerImg.src = "";

      const list = Array.isArray(images) ? images : [];
      if (!list.length){
        gallery.innerHTML = `<div style="color:var(--muted)">No images for this booking.</div>`;
      } else {
        list.forEach((img) => {
          const el = document.createElement("img");
          el.src = img.thumb || "";
          el.alt = img.name || "image";
          el.addEventListener("click", async ()=>{
            try{
              const rec = await idbGetImage(img.id);
              if (!rec?.blob){ toast("Image not found in storage."); return; }
              const url = URL.createObjectURL(rec.blob);
              viewerImg.src = url;
              viewer.style.display = "block";
              viewerImg.onload = () => URL.revokeObjectURL(url);
            }catch(e){
              toast("Cannot load image.");
            }
          });
          gallery.appendChild(el);
        });
      }
      overlay.style.display = "block";
      overlay.setAttribute("aria-hidden", "false");
    }
    function closeImgModal(){
      $("#imgModalOverlay").style.display = "none";
      $("#imgModalOverlay").setAttribute("aria-hidden", "true");
    }

    // Existing images editor UI
    function setExistingImagesUI(images){
      const box = $("#existingImagesBox");
      const grid = $("#existingImagesGrid");
      const list = Array.isArray(images) ? images : [];
      const visible = list.filter(img => img?.id && !currentRemovedImageIds.has(img.id));

      if (!$("#bookingId").value){
        box.style.display = "none";
        grid.innerHTML = "";
        return;
      }

      box.style.display = "block";
      grid.innerHTML = "";

      if (!visible.length){
        grid.innerHTML = `<div style="color:var(--muted)">No existing images.</div>`;
        return;
      }

      visible.forEach((img) => {
        const wrap = document.createElement("div");
        wrap.className = "imgEditItem";
        wrap.innerHTML = `
          <img src="${escapeAttr(img.thumb || "")}" alt="img" data-preview="${escapeAttr(img.id)}" />
          <div class="imgEditActions">
            <button class="miniBtn danger" type="button" data-remove="${escapeAttr(img.id)}" title="Remove">üóëÔ∏è</button>
          </div>
        `;
        grid.appendChild(wrap);
      });

      grid.querySelectorAll("[data-preview]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const b = loadBookings().find(x=>x.id === $("#bookingId").value);
          const still = (b?.images || []).filter(x => x?.id && !currentRemovedImageIds.has(x.id));
          openImgModal(still);
        });
      });

      grid.querySelectorAll("[data-remove]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const imgId = btn.getAttribute("data-remove");
          currentRemovedImageIds.add(imgId);
          const b = loadBookings().find(x=>x.id === $("#bookingId").value);
          setExistingImagesUI(b?.images || []);
        });
      });
    }

    // Customers modal/table
    function openCustModal(customer){
      $("#custEditId").value = customer.id;
      $("#custEditName").value = customer.name || "";
      $("#custEditEmail").value = customer.email || "";
      $("#custEditPhone").value = customer.phone || "";
      $("#custEditNotes").value = customer.notes || "";
      $("#custModalOverlay").style.display = "block";
      $("#custModalOverlay").setAttribute("aria-hidden", "false");
      $("#custEditName").focus();
    }
    function closeCustModal(){
      $("#custModalOverlay").style.display = "none";
      $("#custModalOverlay").setAttribute("aria-hidden", "true");
    }
    function renderCustomersTable(){
      const customers = loadCustomers().slice().sort((a,b)=>a.name.localeCompare(b.name));
      const tbody = $("#customersTbody");
      tbody.innerHTML = "";

      if (!customers.length){
        tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted);padding:16px;">No customers yet.</td></tr>`;
        return;
      }

      customers.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><div style="font-weight:900">${escapeHtml(c.name)}</div></td>
          <td>${escapeHtml(c.email || "‚Äî")}</td>
          <td>${escapeHtml(c.phone || "‚Äî")}</td>
          <td>
            <div class="actions">
              <button class="iconbtn" type="button" data-edit-cust="${escapeAttr(c.id)}" title="Edit">‚úèÔ∏è</button>
              <button class="iconbtn" type="button" data-del-cust="${escapeAttr(c.id)}" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("[data-edit-cust]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-edit-cust");
          const customer = loadCustomers().find(x => x.id === id);
          if (!customer) return;
          openCustModal(customer);
        });
      });

      tbody.querySelectorAll("[data-del-cust]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del-cust");
          if (loadBookings().some(b=>b.customerId === id)){
            toast("Customer is used by bookings. Delete bookings first.");
            return;
          }

          openConfirm({
            title: "Delete customer?",
            text: "This customer will be permanently deleted.",
            onYes: async () => {
              const next = loadCustomers().filter(c=>c.id !== id);
              saveCustomers(next);
              renderCustomersTable();
              buildCustomerIndex();
              toast("Customer deleted.");
            }
          });
        });
      });
    }

    // Shared bookings renderer
    function bookingsToRows({ tbodyEl, searchValue, typeFilter, onlyUpcoming, sortMode }){
      const q = (searchValue || "").trim().toLowerCase();
      const customers = loadCustomers();
      const byId = new Map(customers.map(c=>[c.id,c]));
      let bookings = loadBookings().slice();

      if (onlyUpcoming) bookings = bookings.filter(b => isUpcoming(b.bookingDate));
      if (typeFilter) bookings = bookings.filter(b => (b.bookingType || "") === typeFilter);

      if (sortMode === "nearest") bookings.sort((a,b)=> new Date(a.bookingDate) - new Date(b.bookingDate));
      else bookings.sort((a,b)=> new Date(b.bookingDate) - new Date(a.bookingDate));

      bookings = bookings.filter(b=>{
        if (!q) return true;
        const c = byId.get(b.customerId);
        const hay = [b.bookingType, c?.name, c?.phone, c?.email, b.status, b.paymentMethod, b.bookingDate, b.note]
          .filter(Boolean).join(" ").toLowerCase();
        return hay.includes(q);
      });

      const tbody = tbodyEl;
      tbody.innerHTML = "";

      if (!bookings.length){
        tbody.innerHTML = `<tr><td colspan="7" style="color:var(--muted);padding:16px;">No bookings found.</td></tr>`;
        return;
      }

      bookings.forEach(b=>{
        const c = byId.get(b.customerId);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${typePill(b.bookingType)}</td>
          <td>
            <div style="font-weight:900;color:var(--accent)">${escapeHtml(c?.name || "Unknown")}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px;">${escapeHtml(c?.email || "")}</div>
          </td>
          <td style="color:var(--accent)">${escapeHtml(c?.phone || "‚Äî")}</td>
          <td>${renderThumbs(b.images, b.id)}</td>
          <td><span class="pill ${pillClass(b.status)}">${escapeHtml(b.status || "‚Äî")}</span></td>
          <td>
            <div style="font-weight:800">${escapeHtml(fmtDT(b.bookingDate))}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px;">${escapeHtml((b.currency||"EUR") + " " + Number(b.total||0).toFixed(2))}</div>
          </td>
          <td>
            <div class="actions">
              <button class="iconbtn" type="button" data-open-gallery="${escapeAttr(b.id)}" title="Images">üñºÔ∏è</button>
              <a class="iconbtn" href="#/booking/${encodeURIComponent(b.id)}" title="Edit">‚úèÔ∏è</a>
              <button class="iconbtn" type="button" data-del-booking="${escapeAttr(b.id)}" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("[data-del-booking]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del-booking");
          openConfirm({
            title: "Delete booking?",
            text: "This booking will be permanently deleted (including images).",
            onYes: async () => {
              const bookingsAll = loadBookings();
              const b = bookingsAll.find(x=>x.id === id);
              if (b?.images?.length){
                for (const img of b.images) {
                  if (img?.id) await idbDeleteImage(img.id).catch(()=>{});
                }
              }
              saveBookings(bookingsAll.filter(x=>x.id !== id));
              route();
              toast("Booking deleted.");
            }
          });
        });
      });

      tbody.querySelectorAll("[data-open-gallery]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-open-gallery");
          const b = loadBookings().find(x=>x.id === id);
          openImgModal(b?.images || []);
        });
      });

      tbody.querySelectorAll(".thumb[data-open-gallery]").forEach(img=>{
        img.addEventListener("click", ()=>{
          const id = img.getAttribute("data-open-gallery");
          const b = loadBookings().find(x=>x.id === id);
          openImgModal(b?.images || []);
        });
      });
    }

    // Booking form
    function calcRemaining(){
      const total = money($("#total").value);
      const adv = money($("#advance").value);
      $("#remaining").value = Math.max(0, total - adv).toFixed(2);
    }
    function setBookingSaving(isSaving){
      const btn = $("#saveBookingBtn");
      btn.disabled = isSaving;
      btn.textContent = isSaving ? "Saving..." : "Save booking";
    }
    function parseDatetimeLocalToISO(val){
      const m = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/.exec(val || "");
      if (!m) return null;
      const [_, y, mo, d, h, mi] = m;
      const dt = new Date(Number(y), Number(mo)-1, Number(d), Number(h), Number(mi), 0, 0);
      if (Number.isNaN(dt.getTime())) return null;
      return dt.toISOString();
    }

    function resetBookingForm(){
      currentRemovedImageIds = new Set();
      $("#bookingForm").reset();
      $("#bookingId").value = "";
      $("#customerId").value = "";
      $("#customerSearch").value = "";
      $("#currency").value = "EUR";
      $("#status").value = "Approved";
      $("#paymentMethod").value = "Cash";
      $("#bookingType").value = "Design";
      $("#remaining").value = "0.00";
      showAddCustomerBox(false);
      clearNewCustomerFields();
      $("#existingImagesBox").style.display = "none";
      $("#existingImagesGrid").innerHTML = "";

      const d = new Date();
      d.setMinutes(d.getMinutes() + 60);
      d.setSeconds(0,0);
      d.setMinutes(d.getMinutes() < 30 ? 0 : 30);
      $("#bookingDate").value = toLocalDT(d);

      calcRemaining();
    }

    function setBookingMode(mode, id=""){
      $("#deleteBookingBtn").style.display = mode === "edit" ? "inline-flex" : "none";
      $("#bookingFormTitle").textContent = mode === "edit" ? `Edit Booking [${id}]` : "+ New Booking";
    }

    function loadBookingIntoForm(id){
      const b = loadBookings().find(x=>x.id === id);
      if (!b) return false;

      $("#bookingId").value = b.id;
      setSelectedCustomerById(b.customerId);

      $("#paymentMethod").value = b.paymentMethod || "Cash";
      $("#bookingType").value = b.bookingType || "Design";
      $("#status").value = b.status || "Approved";
      $("#currency").value = b.currency || "EUR";

      const d = new Date(b.bookingDate);
      $("#bookingDate").value = Number.isNaN(d.getTime()) ? "" : toLocalDT(d);

      $("#total").value = Number(b.total||0).toFixed(2);
      $("#advance").value = Number(b.advance||0).toFixed(2);
      $("#note").value = b.note || "";
      calcRemaining();

      setExistingImagesUI(b.images || []);
      return true;
    }

    async function saveBooking(){
      const custId = validateAndGetCustomerId();
      if (!custId) return false;

      const dateVal = $("#bookingDate").value;
      if (!dateVal){ toast("Booking date is required."); return false; }
      const iso = parseDatetimeLocalToISO(dateVal);
      if (!iso){ toast("Invalid date format."); return false; }

      const id = $("#bookingId").value || uid("b_");
      const total = money($("#total").value);
      const advance = money($("#advance").value);
      const remaining = Math.max(0, total - advance);

      const bookings = loadBookings();
      const idx = bookings.findIndex(x=>x.id === id);
      const prev = idx >= 0 ? bookings[idx] : null;

      let images = Array.isArray(prev?.images) ? prev.images.filter(img => img?.id && !currentRemovedImageIds.has(img.id)) : [];

      if (prev?.images?.length && currentRemovedImageIds.size){
        for (const img of prev.images) {
          if (img?.id && currentRemovedImageIds.has(img.id)) {
            await idbDeleteImage(img.id).catch(()=>{});
          }
        }
      }

      try{
        const added = await readAndStoreImages($("#images"));
        images = images.concat(added);
      }catch(e){
        toast("Image storage error. Saving booking without new images.");
      }

      const booking = {
        id,
        customerId: custId,
        paymentMethod: $("#paymentMethod").value,
        bookingType: $("#bookingType").value,
        bookingDate: iso,
        status: $("#status").value,
        currency: $("#currency").value,
        total, advance, remaining,
        note: $("#note").value.trim(),
        images,
        updatedAt: new Date().toISOString(),
      };

      try{
        if (idx >= 0) bookings[idx] = { ...bookings[idx], ...booking };
        else bookings.push({ ...booking, createdAt: new Date().toISOString() });
        saveBookings(bookings);
        return true;
      }catch(e){
        toast("Storage error: cannot save booking metadata.");
        return false;
      }
    }

    // Views
    function showView(id){
      const ids = ["#view-upcoming","#view-bookings-hub","#view-bookings-list","#view-booking-form","#view-customers"];
      ids.forEach(v => $(v).style.display = (v === id) ? "block" : "none");
    }

    // Routing
    function route(){
      const hash = location.hash || "#/upcoming";
      const parts = hash.replace(/^#/,"").split("/").filter(Boolean);
      $("#headerSubtitle").textContent = "Bookings & customers management";

      if (!parts.length || parts[0] === "upcoming"){
        setActiveDrawer("/upcoming");
        showView("#view-upcoming");
        bookingsToRows({
          tbodyEl: $("#upTbody"),
          searchValue: $("#upSearch").value,
          typeFilter: ($("#upTypeFilter").value || "").trim(),
          onlyUpcoming: true,
          sortMode: "nearest",
        });
        return;
      }

      if (parts[0] === "bookings" && parts.length === 1){
        setActiveDrawer("/bookings");
        showView("#view-bookings-hub");
        return;
      }

      if (parts[0] === "bookings" && (parts[1] === "design" || parts[1] === "tattoo")){
        setActiveDrawer("/bookings");
        showView("#view-bookings-list");
        const type = parts[1] === "design" ? "Design" : "Tattoo";
        $("#allTitle").textContent = `${type} bookings`;
        $("#headerSubtitle").textContent = `${type} bookings (newest first)`;
        bookingsToRows({
          tbodyEl: $("#allTbody"),
          searchValue: $("#allSearch").value,
          typeFilter: type,
          onlyUpcoming: false,
          sortMode: "newest",
        });
        return;
      }

      if (parts[0] === "booking" && parts[1] === "new"){
        setActiveDrawer("/booking/new");
        showView("#view-booking-form");
        setBookingMode("new");
        resetBookingForm();
        return;
      }

      if (parts[0] === "booking" && parts[1]){
        setActiveDrawer("/upcoming");
        showView("#view-booking-form");
        const id = decodeURIComponent(parts[1]);
        setBookingMode("edit", id);
        resetBookingForm();
        if (!loadBookingIntoForm(id)) toast("Booking not found.");
        return;
      }

      if (parts[0] === "customers"){
        setActiveDrawer("/customers");
        showView("#view-customers");
        renderCustomersTable();
        return;
      }

      location.hash = "#/upcoming";
    }

    // Logo
    function setLogoLocal(){
      $("#topLogo").src = LOGO_URL;
      $("#drawerLogo").src = LOGO_URL;
    }

    // Events
    window.addEventListener("hashchange", route);

    $("#hambtn").addEventListener("click", openDrawer);
    $("#drawerClose").addEventListener("click", closeDrawer);
    $("#drawerOverlay").addEventListener("click", closeDrawer);

    document.querySelectorAll("#drawerNav .navItem").forEach(item=>{
      item.addEventListener("click", ()=> go(item.dataset.route));
    });

    // brand click -> upcoming
    $("#topBrandLink").addEventListener("click", goUpcoming);
    $("#drawerBrandLink").addEventListener("click", goUpcoming);

    $("#upSearch").addEventListener("input", route);
    $("#upTypeFilter").addEventListener("change", route);
    $("#allSearch").addEventListener("input", route);

    $("#total").addEventListener("input", calcRemaining);
    $("#advance").addEventListener("input", calcRemaining);

    $("#cancelBookingBtn").addEventListener("click", ()=> location.hash = "#/upcoming");

    $("#bookingForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      setBookingSaving(true);
      try{
        const ok = await saveBooking();
        if (!ok) return;
        toast("Booking saved.");
        location.hash = "#/upcoming";
      } finally {
        setBookingSaving(false);
      }
    });

    $("#deleteBookingBtn").addEventListener("click", ()=>{
      const id = $("#bookingId").value;
      if (!id) return;

      openConfirm({
        title: "Delete booking?",
        text: "This booking will be permanently deleted (including images).",
        onYes: async () => {
          const bookings = loadBookings();
          const b = bookings.find(x=>x.id === id);
          if (b?.images?.length){
            for (const img of b.images) {
              if (img?.id) await idbDeleteImage(img.id).catch(()=>{});
            }
          }
          saveBookings(bookings.filter(x=>x.id !== id));
          toast("Booking deleted.");
          location.hash = "#/upcoming";
        }
      });
    });

    $("#removeAllImagesBtn").addEventListener("click", ()=>{
      const id = $("#bookingId").value;
      if (!id) return;
      const b = loadBookings().find(x=>x.id === id);
      const imgs = b?.images || [];
      if (!imgs.length) return;

      openConfirm({
        title: "Remove all images?",
        text: "All existing images will be removed when you Save booking.",
        onYes: async () => {
          imgs.forEach(img => { if (img?.id) currentRemovedImageIds.add(img.id); });
          setExistingImagesUI(imgs);
          toast("Images marked for removal. Tap Save booking.");
        }
      });
    });

    $("#customerSearch").addEventListener("input", ()=>{
      const label = $("#customerSearch").value.trim();
      const map = window.__customerLabelToId || new Map();
      const id = map.get(label);
      if (id){
        $("#customerId").value = id;
        showAddCustomerBox(false);
      } else {
        clearSelectedCustomer();
      }
    });

    $("#addCustomerBtn").addEventListener("click", ()=>{
      showAddCustomerBox(true);
      clearSelectedCustomer();
    });

    $("#custModalClose").addEventListener("click", closeCustModal);
    $("#custEditCancel").addEventListener("click", closeCustModal);
    $("#custModalOverlay").addEventListener("click", (e)=>{
      if (e.target === $("#custModalOverlay")) closeCustModal();
    });

    $("#custEditForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const id = $("#custEditId").value;
      const name = $("#custEditName").value.trim();
      if (!name){ toast("Name is required."); return; }

      const customers = loadCustomers();
      const idx = customers.findIndex(c => c.id === id);
      if (idx < 0){ closeCustModal(); return; }

      customers[idx] = {
        ...customers[idx],
        name,
        email: $("#custEditEmail").value.trim(),
        phone: normalizeFiPhone($("#custEditPhone").value.trim()),
        notes: $("#custEditNotes").value.trim(),
        updatedAt: new Date().toISOString(),
      };

      try{
        saveCustomers(customers);
        buildCustomerIndex();
        const selected = $("#customerId").value;
        if (selected === id) setSelectedCustomerById(id);
        renderCustomersTable();
        route();
        toast("Customer updated.");
        closeCustModal();
      }catch(e){
        toast("Storage error: cannot save customer edits.");
      }
    });

    $("#imgModalClose").addEventListener("click", closeImgModal);
    $("#imgModalOverlay").addEventListener("click", (e)=>{
      if (e.target === $("#imgModalOverlay")) closeImgModal();
    });

    window.addEventListener("error", (e)=> toast("App error: " + (e?.message || "unknown")));
    window.addEventListener("unhandledrejection", (e)=> toast("Promise error: " + (e?.reason?.message || "unknown")));

    (async function init(){
      setLogoLocal();
      try { await openDb(); } catch {}
      buildCustomerIndex();
      enforcePlus358($("#newCustPhone"));
      enforcePlus358($("#custEditPhone"));
      route();
    })();
  </script>
</body>
</html>